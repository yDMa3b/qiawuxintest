<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <title>å¥¶å¥¶çš„éº»å°† (ç»å…¸ç‰Œé¢ç¨³å®šç‰ˆ)</title>
    <style>
        /* --- 1. å…¨å±€è®¾ç½® --- */
        html, body {
            background-color: #0b4d28 !important; 
            width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; 
            user-select: none; -webkit-user-select: none; 
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", "KaiTi", sans-serif;
            position: fixed; top:0; left:0; right:0; bottom:0; 
        }

        /* --- 2. å°ºå¯¸å˜é‡ (Redmi Pad Pro 12.1å¯¸ä¸“å±) --- */
        :root {
            --tile-w: 72px; 
            --tile-h: 104px; 
            --font-base: 22px;
            --font-lg: 32px;
            --font-xl: 50px;
            --opp-area-h: 220px; 
        }

        /* --- 3. é¢œè‰²å®šä¹‰ (è¾…åŠ©å¢å¼ºè§†è§‰) --- */
        .c-tong { color: #0055aa !important; } 
        .c-tiao { color: #008800 !important; } 
        .c-red  { color: #cc0000 !important; } 

        /* å¯åŠ¨å±‚ */
        #start-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 20000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            font-size: 40px; padding: 20px 80px; background: #d32f2f; color: white;
            border: 5px solid white; border-radius: 60px; font-weight: bold; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); 
            color: #ffcccc; font-size: 14px; z-index: 30000; padding: 5px; pointer-events: none; display: none;
        }

        /* å¤§å… */
        #lobby-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0b4d28 0%, #002200 100%);
            z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lobby-title { font-size: 60px; color: gold; font-weight: bold; margin-bottom: 40px; text-shadow: 4px 4px 10px #000; }
        .lobby-info { font-size: 30px; color: #fff; margin-bottom: 50px; background: rgba(0,0,0,0.4); padding: 15px 40px; border-radius: 40px; }
        .room-container { display: flex; gap: 50px; justify-content: center; width: 100%; }
        .room-btn {
            width: 260px; height: 260px; border-radius: 30px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; box-shadow: 0 15px 30px rgba(0,0,0,0.6); 
            cursor: pointer; transition: transform 0.1s; position: relative;
            border: 2px solid rgba(255,255,255,0.4);
        }
        .room-btn:active { transform: scale(0.95); }
        .bg-green { background: linear-gradient(to bottom, #66bb6a, #2e7d32); }
        .bg-blue { background: linear-gradient(to bottom, #42a5f5, #1565c0); }
        .bg-red { background: linear-gradient(to bottom, #ef5350, #c62828); }
        .room-name { font-size: 32px; font-weight: bold; margin-bottom: 10px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .room-desc { font-size: 20px; opacity: 0.9; }
        .room-lock { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); border-radius:30px; display:none; 
            justify-content:center; align-items:center; font-size:60px; z-index: 10;
        }

        /* æ¸¸æˆå±‚ */
        #game-layer { 
            display: none; width: 100%; height: 100%; 
            position: absolute; top:0; left:0; z-index: 100; overflow: hidden; 
        }

        .header { 
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 40px; box-sizing: border-box;
            font-size: 24px; color: gold; background: rgba(0,0,0,0.3); font-family: sans-serif;
            z-index: 50; text-shadow: 1px 1px 2px #000;
        }

        .opponents { 
            position: absolute; top: 60px; left: 0; width: 100%; height: var(--opp-area-h);
            display: flex; justify-content: space-between; 
            padding: 10px 60px; box-sizing: border-box; pointer-events: none;
            z-index: 10;
        }
        .opp-box { width: 35%; display: flex; flex-direction: column; pointer-events: auto; }
        .opp-box:first-child { align-items: flex-start; }
        .opp-box:last-child { align-items: flex-end; }

        .opp-name { font-size: 24px; color: #ddd; margin-bottom: 5px; text-shadow: 1px 1px 2px #000; display: flex; align-items: center; gap: 10px;}
        
        .opp-hand { 
            background: rgba(0,0,0,0.3); padding: 5px 20px; border-radius: 10px; 
            font-size: 22px; color: #ccc; cursor: pointer; transition: background 0.2s;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .opp-hand:active { background: rgba(255,255,255,0.2); }

        .opp-melds { display: flex; height: calc(var(--tile-h) * 0.7); margin-bottom: 5px; justify-content: flex-start; }
        .opp-box:last-child .opp-melds { justify-content: flex-end; }
        
        .river { 
            width: 110%; height: calc(var(--tile-h) * 1.8); 
            background: rgba(0,0,0,0.2); border-radius: 12px; 
            display: flex; flex-wrap: wrap; align-content: flex-start; padding: 5px; margin-top: 5px; 
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3); 
        }
        .opp-box:last-child .river { flex-direction: row-reverse; }

        /* ä¸­é—´ä¿¡æ¯åŒº (Z: 500) */
        .center-stage { 
            position: absolute; top: 38%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            pointer-events: none; 
            z-index: 500;
        }
        #msg { 
            font-size: 36px; color: white; background: rgba(0,0,0,0.85); 
            padding: 10px 40px; border-radius: 50px; margin-bottom: 15px; font-weight: bold; 
            text-align: center; pointer-events: auto;
            border: 2px solid rgba(255,255,255,0.5); box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            white-space: nowrap;
        }
        #big-card { width: calc(var(--tile-w) * 2.2); height: calc(var(--tile-h) * 2.2); display: flex; justify-content: center; align-items: center; }

        /* ç©å®¶åŒºåŸŸ (Z: 40) */
        .my-area { 
            position: absolute; bottom: 0; left: 0; width: 100%;
            display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 15px; 
            z-index: 40; 
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, rgba(0,0,0,0) 100%);
        }

        .my-river-box { 
            display: flex; flex-direction: column; align-items: center; 
            margin-bottom: 5px; pointer-events: none;
        }
        
        .river-toggle-btn {
            pointer-events: auto;
            background: rgba(0,0,0,0.5); color: gold;
            border: 1px solid gold; border-radius: 15px;
            padding: 4px 15px; margin-bottom: 5px;
            font-size: 18px; cursor: pointer;
            font-weight: bold; font-family: sans-serif;
            transition: all 0.2s;
        }
        .river-toggle-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.7); }

        .my-river { 
            width: 60%; height: calc(var(--tile-h) * 1.4); 
            background: rgba(0,0,0,0.25); border-radius: 12px; 
            display: flex; flex-wrap: wrap; justify-content: center; padding: 8px; pointer-events: auto;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            transition: height 0.3s ease, opacity 0.3s ease; 
        }
        
        .my-river.collapsed {
            height: 0 !important; padding: 0 !important;
            overflow: hidden; opacity: 0; border: none;
        }
        
        .my-info-row { display: flex; justify-content: center; align-items: center; height: 40px; margin-bottom: 5px; }
        
        .btn-row { 
            display: flex; justify-content: center; gap: 50px; height: 80px; align-items: center; 
            margin-bottom: 15px; z-index: 600; pointer-events: none;
        }
        .btn-row button { pointer-events: auto; } 
        
        .btn { 
            padding: 15px 50px; border-radius: 50px; border: none; 
            font-size: 30px; font-weight: bold; box-shadow: 0 8px 15px rgba(0,0,0,0.6); 
            transition: transform 0.1s; cursor: pointer; white-space: nowrap; font-family: sans-serif;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        .btn:active { transform: scale(0.9); box-shadow: 0 4px 8px rgba(0,0,0,0.6); }
        .btn-hu { background: linear-gradient(to bottom, #d32f2f, #b71c1c); color: white; animation: pulse 1s infinite; border: 2px solid #ff8a80; }
        .btn-peng { background: linear-gradient(to bottom, #1976d2, #0d47a1); color: white; border: 2px solid #82b1ff; }
        .btn-gang { background: linear-gradient(to bottom, #7b1fa2, #4a148c); color: white; border: 2px solid #ea80fc; }
        .btn-pass { background: linear-gradient(to bottom, #757575, #424242); color: white; border: 2px solid #bdbdbd; }
        .btn-liang { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 3px solid white; box-shadow: 0 0 25px #ffeb3b; }
        .btn-out { background: gold; color: black; display: none; padding: 15px 100px; border: 4px solid #fff; box-shadow: 0 0 20px gold;}

        .hand-row { display: flex; justify-content: center; align-items: flex-end; padding: 0 20px 10px 20px; }
        .my-melds { display: flex; margin-right: 40px; align-items: flex-end; }
        .my-hand { display: flex; align-items: flex-end; }

        .ting-box { display: none; background: rgba(0,0,0,0.85); padding: 5px 20px; border-radius: 10px; border: 2px solid #ff9800; align-items: center; margin-bottom: 5px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .ting-txt { color: #ff9800; font-size: 24px; margin-right: 10px; font-family: sans-serif; white-space: nowrap; }
        .liang-tag { background: #ff9800; color: black; font-weight: bold; font-size: 20px; padding: 4px 10px; border-radius: 6px; display: none; border: 2px solid white; font-family: sans-serif;}

        /* --- éº»å°†ç‰Œæ ·å¼ (å›å½’ç»å…¸å­—ç¬¦ç‰ˆ) --- */
        .tile { 
            width: var(--tile-w); height: var(--tile-h); 
            background: #fdfdfd; border-radius: 8px; margin: 3px; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            box-shadow: 3px 5px 6px rgba(0,0,0,0.4); border: 1px solid #bbb;
            flex-shrink: 0;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
            background: linear-gradient(to bottom right, #fff, #f0f0f0);
            overflow: hidden; 
        }
        
        .tile-txt { 
            font-size: calc(var(--tile-w) * 0.9); /* å›å½’æ­£å¸¸æ¯”ä¾‹ */
            line-height: 1; 
            margin-top: -6px; 
            color: #000; 
        }
        
        .tile.selected { transform: translateY(-35px); border: 3px solid gold; background: #fffbe6; z-index: 10; overflow: visible; }
        .tile-dropped { transform: scale(0.9); margin: -4px -3px; border: 1px solid #ccc; box-shadow: none; opacity: 0.95; }
        .tile-meld { transform: scale(0.85); margin: -6px -4px; background: #eef; }
        .tile-big { transform: scale(2.0); box-shadow: 0 0 60px rgba(255,255,0,0.8); z-index: 2000; background: #fff; border: 4px solid gold; }
        .tile-small { transform: scale(0.7); margin: -10px -5px; }
        .tile-tiny { transform: scale(0.6); margin: -15px -8px; background: #fffbe6; border: 1px solid orange; }

        .bai-ban { width: 75%; height: 80%; border: 4px solid #1046b1; border-radius: 6px; box-sizing: border-box; }

        /* æ‰‹ç‰ŒæŸ¥çœ‹å™¨ */
        .tile-viewer {
            width: calc(var(--tile-w) * 1.6); 
            height: calc(var(--tile-h) * 1.6); 
            margin: 8px 12px; 
            background: #fdfdfd; border-radius: 12px; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            box-shadow: 4px 6px 10px rgba(0,0,0,0.6); border: 1px solid #999;
            flex-shrink: 0; overflow: hidden;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }
        .tile-viewer .tile-txt {
            font-size: calc(var(--tile-w) * 1.6 * 0.9);
            margin-top: -10px;
        }
        .tile-viewer .bai-ban {
            width: 75%; height: 80%; border: 6px solid #1046b1; border-radius: 8px; box-sizing: border-box;
        }

        #hand-viewer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 9000; 
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .viewer-box {
            background: rgba(255,255,255,0.15); padding: 40px; border-radius: 20px;
            border: 3px solid gold; 
            display: flex; flex-wrap: wrap; 
            justify-content: center;
            width: 90%; max-width: 1400px; 
            box-shadow: 0 0 80px rgba(0,0,0,0.9);
        }
        .viewer-tip { color: gold; font-size: 28px; margin-bottom: 25px; font-weight: bold; text-shadow: 2px 2px 4px black; }

        /* ç»“ç®—å¼¹çª— */
        .modal { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 50000; }
        .res-box { background: white; color: #333; width: 60%; max-width: 700px; padding: 40px; border-radius: 30px; text-align: center; box-shadow: 0 0 80px rgba(255,215,0,0.6); border: 6px solid gold;}
        .res-title { font-size: 60px; font-weight: bold; margin-bottom: 30px; font-family: sans-serif; }
        .res-detail { font-size: 28px; color: #555; margin-bottom: 30px; line-height: 1.8; text-align: left; padding-left: 50px; font-family: sans-serif;}
        .res-score { font-size: 80px; font-weight: bold; color: #d32f2f; margin: 20px 0; font-family: sans-serif; }
        .res-btn { padding: 15px 60px; background: linear-gradient(to bottom, #388e3c, #1b5e20); color: white; border: none; border-radius: 50px; font-size: 32px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-family: sans-serif;}
        
        .toast { position: absolute; top: 40%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: gold; padding: 20px 50px; border-radius: 20px; font-size: 30px; z-index: 60000; display: none; text-align: center; border: 3px solid gold; font-family: sans-serif;}
    </style>
</head>
<body>
    <div id="debug-console"></div>
    <div id="start-layer">
        <button id="start-btn" onclick="initApp()">è¿›å…¥æ¸¸æˆ</button>
    </div>

    <div id="lobby-layer" style="display:none;">
        <div class="lobby-title">ğŸ€„ï¸ å•æœºå¡äº”æ˜Ÿ ğŸ€„ï¸</div>
        <div class="lobby-info">æ‚¨çš„é‡‘è±†: <span id="user-score-disp-1">è¯»å–ä¸­...</span></div>
        <div class="room-container">
            <div class="room-btn bg-green" onclick="enterRoom(0)"><div class="room-name">ğŸŸ¢ åˆçº§åœº</div><div class="room-desc">åº•åˆ†100</div></div>
            <div class="room-btn bg-blue" onclick="enterRoom(1)">
                <div class="room-name">ğŸ”µ ä¸­çº§åœº</div><div class="room-desc">åº•åˆ†500</div>
                <div class="room-lock" id="lock-1">ğŸ”’</div>
            </div>
            <div class="room-btn bg-red" onclick="enterRoom(2)">
                <div class="room-name">ğŸ”´ é«˜çº§åœº</div><div class="room-desc">åº•åˆ†2000</div>
                <div class="room-lock" id="lock-2">ğŸ”’</div>
            </div>
        </div>
    </div>

    <div id="hand-viewer" onclick="closeHandView()">
        <div class="viewer-tip">ğŸ‘‡ å¯¹æ‰‹æ‰‹ç‰Œ (ç‚¹å‡»ä»»æ„å¤„å…³é—­) ğŸ‘‡</div>
        <div class="viewer-box" id="viewer-content"></div>
    </div>

    <div id="game-layer">
        <div class="header">
            <div id="room-info-disp" style="color:white; font-weight:bold;">åˆçº§åœº</div>
            <div>ğŸ’° <span id="user-score-disp-2"></span></div>
        </div>

        <div class="opponents">
            <div class="opp-box" onclick="showOppHand(2)">
                <div class="opp-name">â¬…ï¸ ä¸Šå®¶ <span class="liang-tag" id="tag-2">äº®</span></div>
                <div class="ting-box" id="ting-box-2"><span class="ting-txt">èƒ¡:</span><div id="t-tiles-2" style="display:flex"></div></div>
                <div class="opp-melds" id="melds-2"></div>
                <div class="opp-hand" id="hand-2">å‰©13å¼ </div>
                <div class="river" id="river-2"></div>
            </div>
            <div class="opp-box" onclick="showOppHand(1)">
                <div class="opp-name">ä¸‹å®¶ â¡ï¸ <span class="liang-tag" id="tag-1">äº®</span></div>
                <div class="ting-box" id="ting-box-1"><span class="ting-txt">èƒ¡:</span><div id="t-tiles-1" style="display:flex"></div></div>
                <div class="opp-melds" id="melds-1"></div>
                <div class="opp-hand" id="hand-1">å‰©13å¼ </div>
                <div class="river" id="river-1"></div>
            </div>
        </div>

        <div class="center-stage">
            <div id="msg">å‡†å¤‡å¼€å§‹</div>
            <div id="big-card"></div>
        </div>

        <div class="my-area">
            <div class="my-river-box">
                <div id="river-toggle-btn" class="river-toggle-btn" onclick="toggleMyRiver()">ğŸ”½ æ”¶èµ·å¼ƒç‰Œ</div>
                <div class="my-river" id="river-0"></div>
            </div>
            
            <div class="my-info-row">
                <span class="liang-tag" id="tag-0">å·²äº®å€’</span>
                <div class="ting-box" id="ting-box-0" style="margin-left:10px;">
                    <span class="ting-txt">ä½ èƒ¡:</span><div id="t-tiles-0" style="display:flex"></div>
                </div>
            </div>
            <div class="btn-row" id="btn-box"></div>
            <div class="hand-row">
                <div class="my-melds" id="melds-0"></div>
                <div class="my-hand" id="hand-0"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="res-box">
            <div id="res-title" class="res-title">èƒ¡ç‰Œå•¦</div>
            <div id="res-desc" class="res-detail"></div>
            <div id="res-score" class="res-score">+3200</div>
            <button class="res-btn" onclick="backToLobby()">è¿”å›å¤§å…</button>
        </div>
    </div>
    
    <div class="toast" id="toast">ç ´äº§äº†ï¼<br>ç³»ç»Ÿèµ é€ 3000 æ•‘æµé‡‘</div>

<script>
    // --- 1. æ ¸å¿ƒå·¥å…·å‡½æ•° (å‰ç½®å®šä¹‰ï¼Œè§£å†³ not defined æŠ¥é”™) ---
    function safeStyle(id, prop, val) { 
        var el = document.getElementById(id); 
        if (el) el.style[prop] = val; 
    }
    
    function safeHtml(id, html) { 
        var el = document.getElementById(id); 
        if (el) el.innerHTML = html; 
    }
    
    function setMsg(t) { 
        var el = document.getElementById('msg'); 
        if(el) el.innerText = t; 
    }
    
    function hideActs() { 
        safeHtml('btn-box', ''); 
    }
    
    function showActs(list, showBase) {
        var box = document.getElementById('btn-box'); 
        if(!box) return;
        box.innerHTML='';
        
        // ä¿®å¤ç‚¹ï¼šç›´æ¥åœ¨è¿™é‡Œåˆ›å»ºå‡ºç‰ŒæŒ‰é’®ï¼Œé¿å…è¢«è¯¯åˆ 
        if(showBase) {
            var btn = document.createElement('button');
            btn.className = 'btn btn-out';
            btn.id = 'btn-out';
            btn.innerText = 'å‡ºç‰Œ';
            btn.onclick = actDiscard;
            btn.style.display = 'block'; 
            box.appendChild(btn);
        }
        
        for(var i=0;i<list.length;i++) {
            (function(a){
                var b=document.createElement('button');
                b.className='btn btn-'+a.toLowerCase();
                b.innerText = (a=='HU'?"èƒ¡":(a=='PENG'?"ç¢°":(a=='GANG'?"æ ":(a=='PASS'?"è¿‡":(a=='LIANG'?"äº®å€’":"")))));
                if(a=='PASS' && G.ps[0].liang) { b.innerText="æ‰“å‡º"; b.className+=' btn-pass'; }
                b.onclick=function(){doAct(a)}; box.appendChild(b);
            })(list[i]);
        }
    }

    var debug = document.getElementById('debug-console');
    window.onerror = function(msg, url, line) {
        if(debug) { debug.style.display = 'block'; debug.innerHTML += "Err: " + msg + " (L" + line + ")<br>"; }
        return false;
    };

    // å­—ç¬¦è¡¨ (å›å½’ç»å…¸)
    var TILE_CHARS = [
        'ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡', 
        'ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜', 
        'ğŸ€„','ğŸ€…','' 
    ];

    var ROOMS = [
        {name:"åˆçº§åœº", min:0, base:100, ai:0},
        {name:"ä¸­çº§åœº", min:10000, base:500, ai:1},
        {name:"é«˜çº§åœº", min:50000, base:2000, ai:2}
    ];
    var SCORE = 100000;
    
    function loadData() {
        try {
            var s = localStorage.getItem('nainai_mahjong_score');
            if(s) { SCORE = parseInt(s); if(isNaN(SCORE)) SCORE = 100000; } else SCORE = 100000;
            if(SCORE < 50000) SCORE = 100000; // æµ‹è¯•ç”¨ï¼šå¼ºåˆ¶è¡¥åˆ†
        } catch(e) { console.error(e); }
    }
    function saveData() { try { localStorage.setItem('nainai_mahjong_score', SCORE); } catch(e){} }

    var CUR_ROOM = null;
    var G = { deck:[], ps:[], turn:0, last:-1, from:-1, sel:-1, drawn:false, gangInfo:null, pendingLiang:false };

    function initApp() { loadData(); safeStyle('start-layer', 'display', 'none'); initLobby(); }

    function initLobby() {
        safeStyle('lobby-layer', 'display', 'flex');
        safeStyle('game-layer', 'display', 'none');
        safeStyle('modal', 'display', 'none');
        safeStyle('hand-viewer', 'display', 'none'); 
        if(SCORE <= 0) { 
            SCORE = 3000; saveData(); 
            safeStyle('toast', 'display', 'block'); 
            setTimeout(function(){safeStyle('toast', 'display', 'none')}, 2500); 
        }
        updateGlobalScore();
        safeStyle('lock-1', 'display', SCORE < 10000 ? 'flex' : 'none');
        safeStyle('lock-2', 'display', SCORE < 50000 ? 'flex' : 'none');
    }

    function updateGlobalScore() {
        var el1 = document.getElementById('user-score-disp-1'); if(el1) el1.innerText = SCORE;
        var el2 = document.getElementById('user-score-disp-2'); if(el2) el2.innerText = SCORE;
    }

    function enterRoom(id) {
        var r = ROOMS[id];
        if(SCORE < r.min) { alert("é‡‘è±†ä¸è¶³ï¼"); return; }
        CUR_ROOM = r;
        safeStyle('lobby-layer', 'display', 'none');
        safeStyle('game-layer', 'display', 'block');
        var ri = document.getElementById('room-info-disp');
        if(ri) ri.innerText = r.name + " (åº•åˆ†"+r.base+")";
        updateGlobalScore();
        startGame();
    }
    function backToLobby() { initLobby(); }

    function startGame() {
        hideActs();
        G.deck=[]; for(var i=0;i<=20;i++) for(var k=0;k<4;k++) G.deck.push(i);
        for(var i=G.deck.length-1;i>0;i--) { var j=Math.floor(Math.random()*(i+1)); var t=G.deck[i]; G.deck[i]=G.deck[j]; G.deck[j]=t; }
        G.ps = [];
        for(var i=0;i<3;i++) {
            var s = (i==0 ? SCORE : 100000);
            var h=[]; for(var k=0;k<13;k++) h.push(G.deck.pop());
            h.sort(function(a,b){return a-b});
            G.ps.push({ hand:h, meld:[], river:[], liang:false, ting:[], score:s });
        }
        G.turn = 0; G.drawn = false; G.sel = -1; G.pendingLiang = false;
        
        var r = document.getElementById('river-0');
        var b = document.getElementById('river-toggle-btn');
        if(r) r.className = 'my-river'; 
        if(b) b.innerText = 'ğŸ”½ æ”¶èµ·å¼ƒç‰Œ';
        
        render(); setMsg("åº„å®¶æ‘¸ç‰Œ...");
        setTimeout(drawCard, 800);
    }

    function checkAvailableActs(p) {
        showActs([], true);
        var acts = [];
        var canLiang = checkCanLiang(p.hand, p.meld);
        var gangInfo = checkGang(p);
        if(canLiang) acts.push('LIANG');
        if(gangInfo) { G.gangInfo = gangInfo; acts.push('GANG'); }
        if(acts.length > 0) {
            showActs(acts, true);
            if(!canLiang && gangInfo) setMsg("æœ‰æ ");
            else setMsg("è¯·é€‰æ‹©æ“ä½œ");
        } else {
            setMsg("è¯·å‡ºç‰Œ");
        }
    }

    function drawCard() {
        try {
            if(G.deck.length==0) { alert("æµå±€"); backToLobby(); return; }
            var p = G.ps[G.turn]; var c = G.deck.pop(); p.hand.push(c);
            
            if(G.turn == 0) { 
                G.drawn = true; G.sel = -1; render();
                if(p.liang) {
                    setMsg("å·²äº®å€’ï¼šè‡ªåŠ¨æ‰“ç‰Œ");
                    if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("äº®å€’è‡ªæ‘¸ï¼"); }
                    else { setTimeout(function(){ actDiscardForce(p.hand.length-1); }, 1000); }
                    return;
                }
                if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("æ‘¸åˆ°å¥½ç‰Œï¼"); }
                else { checkAvailableActs(p); }
            } else { 
                render(); setMsg((G.turn==1?"ä¸‹å®¶":"ä¸Šå®¶")+"æ€è€ƒä¸­...");
                setTimeout(function(){ aiPlay(p); }, 800);
            }
        } catch(e) { console.error(e); }
    }

    function aiPlay(p) {
        try {
            if(checkWin(p.hand, p.meld)) { showResult(G.turn, "ç”µè„‘èƒ¡äº†", 0, "è‡ªæ‘¸", true); return; }
            if(!p.liang && CUR_ROOM.ai > 0) {
                for(var i=0; i<p.hand.length; i++) {
                    var tmp = p.hand.slice(); var dc = tmp.splice(i,1)[0];
                    var tings = getWinTiles(tmp, p.meld);
                    if(tings.length>0 && Math.random() < (CUR_ROOM.ai==2?0.9:0.6)) {
                        p.liang=true; p.ting=tings; p.hand=tmp;
                        G.last = dc; G.from = G.turn; G.drawn = false;
                        showBig(dc); render(); checkResp(); return;
                    }
                }
            }
            if(p.liang) { var c = p.hand.pop(); playCard(c); return; }
            var danger = (G.ps[0].liang && CUR_ROOM.ai==2) ? G.ps[0].ting : [];
            var counts={}; for(var i=0;i<p.hand.length;i++) counts[p.hand[i]]=(counts[p.hand[i]]||0)+1;
            var best = -1;
            for(var i=0; i<p.hand.length; i++) {
                var t = p.hand[i];
                if(danger.indexOf(t)==-1) {
                    if(counts[t]==1) { if(t>=18) { best=i; break; } if(best==-1) best=i; }
                }
            }
            if(best==-1) best = Math.floor(Math.random()*p.hand.length);
            var c = p.hand.splice(best, 1)[0]; p.hand.sort(function(a,b){return a-b});
            playCard(c);
        } catch(e) { console.error(e); }
    }

    function playCard(c) { 
        G.last = c; G.from = G.turn; G.drawn = false; 
        showBig(c); render(); checkResp(); 
    }

    function checkResp() {
        var c = G.last;
        if(G.from != 0) {
            var p = G.ps[0]; var acts = [];
            var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
            if(checkWin(tmp, p.meld)) acts.push('HU');
            if(!p.liang) {
                var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
                if(cnt>=2) acts.push('PENG'); if(cnt==3) acts.push('GANG');
            }
            if(acts.length>0) { acts.push('PASS'); showActs(acts); setMsg("æœ‰æ“ä½œ"); return; }
        }
        var n1 = (G.from+1)%3; if(aiResp(n1, c)) return;
        var n2 = (G.from+2)%3; if(aiResp(n2, c)) return;
        G.ps[G.from].river.push(c); nextTurn();
    }

    function aiResp(id, c) {
        if(id==0 || id==G.from) return false;
        var p = G.ps[id];
        var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
        if(checkWin(tmp, p.meld)) { showResult(id, "ç”µè„‘èƒ¡äº†", 0, "æ‰ç‚®", false); return true; }
        if(p.liang) return false;
        var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
        var rate = CUR_ROOM.ai==2 ? 0.9 : 0.5;
        if(cnt==3) { aiAct(id, 'gang', c); return true; }
        if(cnt>=2 && Math.random()<rate) { aiAct(id, 'peng', c); return true; }
        return false;
    }

    function aiAct(id, type, c) {
        var p = G.ps[id];
        rem(p.hand, c, (type=='gang'?3:2)); p.meld.push({v:c, t:type});
        G.turn = id; safeHtml('big-card', '');
        setMsg("ç”µè„‘"+(type=='gang'?"æ ":"ç¢°")); render();
        if(type=='gang') setTimeout(drawCard, 800);
        else setTimeout(function(){
            var dc = p.hand.splice(0,1)[0]; p.hand.sort(function(a,b){return a-b}); playCard(dc);
        }, 800);
    }

    function nextTurn() { safeHtml('big-card', ''); G.turn = (G.turn+1)%3; render(); setTimeout(drawCard, 500); }

    function actDiscard() {
        if(G.sel == -1) return;
        var p = G.ps[0];
        if(p.liang && G.sel != p.hand.length-1) { setMsg("äº®å€’è§„åˆ™ï¼šåªèƒ½æ‰“æ–°æ‘¸çš„ç‰Œ"); return; }
        actDiscardForce(G.sel);
    }
    
    function actDiscardForce(idx) {
        var p = G.ps[0];
        if(G.pendingLiang) {
            var tmpHand = p.hand.slice(); tmpHand.splice(idx, 1); tmpHand.sort(function(a,b){return a-b});
            var tings = getWinTiles(tmpHand, p.meld);
            if(tings.length === 0) { setMsg("æ‰“è¿™å¼ ç‰Œä¸å¬ç‰Œï¼Œæ— æ³•äº®å€’ï¼"); return; }
            p.liang = true;
            p.ting = tings;
            G.pendingLiang = false;
            
            safeStyle('ting-box-0', 'display', 'flex');
            var tH=""; for(var w=0;w<tings.length;w++) tH+=div(tings[w], 'tile-tiny');
            safeHtml('t-tiles-0', tH);
        }

        var c = p.hand.splice(idx, 1)[0]; p.hand.sort(function(a,b){return a-b});
        hideActs(); playCard(c);
    }

    function actLiang() { 
        G.pendingLiang = true; 
        setMsg("è¯·æ‰“å‡ºä¸€å¼ ç‰Œä»¥äº®å€’"); 
        
        var box = document.getElementById('btn-box');
        if(box) {
            box.innerHTML = '';
            var btn = document.createElement('button');
            btn.className = 'btn btn-out';
            btn.id = 'btn-out';
            btn.innerText = 'å‡ºç‰Œ';
            btn.onclick = actDiscard;
            btn.style.display = 'block';
            box.appendChild(btn);
        }
    }

    function actGangSelf() {
        var p = G.ps[0]; var g = G.gangInfo;
        if(g.type=='an') { rem(p.hand, g.v, 4); p.meld.push({v:g.v, t:'gang'}); }
        else { rem(p.hand, g.v, 1); for(var i=0;i<p.meld.length;i++) if(p.meld[i].v==g.v) p.meld[i].t='gang'; }
        G.gangInfo=null; hideActs(); render(); setTimeout(drawCard, 500);
    }
    
    function doAct(a) {
        hideActs(); safeHtml('big-card', '');
        var p = G.ps[0]; var c = G.last;
        if(a=='PASS') {
            if(p.liang && G.turn==0) { var dc = p.hand.pop(); p.hand.sort(function(a,b){return a-b}); playCard(dc); } 
            else { G.ps[G.from].river.push(c); nextTurn(); }
        }
        else if(a=='HU') { showResult(0, "èƒ¡ç‰Œå•¦", 0, "", G.from==0); }
        else if(a=='LIANG') actLiang();
        else if(a=='GANG') { 
            if(G.turn==0) actGangSelf(); else { rem(p.hand,c,3); p.meld.push({v:c,t:'gang'}); G.turn=0; setMsg("æ ï¼Œæ‘¸ä¸€å¼ "); setTimeout(drawCard,500); }
        }
        else if(a=='PENG') { 
            rem(p.hand,c,2); p.meld.push({v:c,t:'peng'}); 
            G.turn=0; G.drawn=true; G.sel=-1; setMsg("ç¢°ï¼Œè¯·å‡ºç‰Œ"); render(); 
            checkAvailableActs(p);
        }
    }

    function clk(idx) {
        if(G.turn!=0 || !G.drawn) return;
        var p = G.ps[0];
        if(p.liang && idx!=p.hand.length-1) { setMsg("äº®å€’ååªèƒ½æ“ä½œæ–°æ‘¸çš„ç‰Œ"); return; }
        var realIdx = (p.liang || (G.turn==0&&G.drawn)) && idx == p.hand.length-1 ? idx : idx;
        if(G.sel == realIdx) actDiscard();
        else { G.sel = realIdx; render(); checkAvailableActs(p); } 
    }

    function toggleMyRiver() {
        var r = document.getElementById('river-0');
        var b = document.getElementById('river-toggle-btn');
        if(!r || !b) return;
        
        if (r.classList.contains('collapsed')) {
            r.classList.remove('collapsed');
            b.innerText = 'ğŸ”½ æ”¶èµ·å¼ƒç‰Œ';
        } else {
            r.classList.add('collapsed');
            b.innerText = 'ğŸ”¼ å±•å¼€å¼ƒç‰Œ';
        }
    }

    function showOppHand(id) {
        var p = G.ps[id];
        if(!p.liang) { 
            setMsg("å¯¹æ‰‹æœªäº®å€’ï¼Œä¸å¯æŸ¥çœ‹");
            return; 
        }
        var vBox = document.getElementById('viewer-content');
        if(vBox) {
            var hH = "";
            for(var i=0; i<p.hand.length; i++) {
                hH += div(p.hand[i], 'tile-viewer'); 
            }
            vBox.innerHTML = hH;
        }
        safeStyle('hand-viewer', 'display', 'flex');
    }

    function closeHandView() {
        safeStyle('hand-viewer', 'display', 'none');
    }

    function checkWin(h, m) {
        if(m.length==0 && h.length==14 && is7(h)) return true;
        var c={}; for(var i=0;i<h.length;i++) c[h[i]]=(c[h[i]]||0)+1;
        var pair=[]; for(var k in c) if(c[k]>=2) pair.push(parseInt(k));
        for(var i=0;i<pair.length;i++) { var cp = h.slice(); removeOne(cp,pair[i]); removeOne(cp,pair[i]); if(isHu(cp)) return true; }
        return false;
    }
    function is7(h){ for(var i=0;i<14;i+=2) if(h[i]!=h[i+1]) return false; return true; }
    function isHu(t) {
        if(t.length==0) return true;
        var f=t[0]; var cnt=0; for(var i=0;i<t.length;i++) if(t[i]==f) cnt++;
        if(cnt>=3) { var cp=t.slice(); removeOne(cp,f); removeOne(cp,f); removeOne(cp,f); if(isHu(cp)) return true; }
        if(f<18) {
            if(t.indexOf(f+1)>-1 && t.indexOf(f+2)>-1) {
                if(Math.floor(f/9) == Math.floor((f+2)/9)) { var cp=t.slice(); removeOne(cp,f); removeOne(cp,f+1); removeOne(cp,f+2); if(isHu(cp)) return true; }
            }
        } return false;
    }
    function removeOne(arr, v) { var idx = arr.indexOf(v); if(idx>-1) { arr.splice(idx, 1); return true; } return false; }
    function rem(a,v,n) { for(var i=0;i<n;i++) removeOne(a,v); }
    function checkGang(p) {
        var c={}; for(var i=0;i<p.hand.length;i++) c[p.hand[i]]=(c[p.hand[i]]||0)+1;
        for(var k in c) if(c[k]==4) return {type:'an', v:parseInt(k)};
        for(var i=0;i<p.hand.length;i++) for(var m=0;m<p.meld.length;m++) if(p.meld[m].t=='peng' && p.meld[m].v==p.hand[i]) return {type:'bu', v:p.hand[i]};
        return null;
    }
    function checkCanLiang(h,m) {
        for(var i=0;i<h.length;i++) {
            var tmp=h.slice(); tmp.splice(i,1);
            if(getWinTiles(tmp,m).length>0) return true;
        } return false;
    }
    function getWinTiles(h13, m) { var w=[]; for(var t=0;t<=20;t++) { var tmp=h13.slice(); tmp.push(t); tmp.sort(function(a,b){return a-b}); if(checkWin(tmp, m)) w.push(t); } return w; }
    function calcFan(h, m, winTile, isZimo, isGangKai) {
        var fan = 1; var details = ["å¹³èƒ¡"];
        if((winTile==4 || winTile==13)) { if(h.indexOf(winTile-1)>-1 && h.indexOf(winTile+1)>-1) { fan *= 2; details.push("å¡äº”æ˜Ÿ x2"); } }
        if(m.length==0 && h.length==14 && is7(h)) { fan *= 4; details.push("ä¸ƒå¯¹ x4"); }
        else if(isPPH(h, m)) { fan *= 2; details.push("ç¢°ç¢°èƒ¡ x2"); }
        if(isGangKai) { fan *= 2; details.push("æ ä¸Šå¼€èŠ± x2"); }
        if(isZimo) { details.push("è‡ªæ‘¸"); } else { details.push("æ‰ç‚®"); }
        return {fan:fan, desc:details.join(" ")};
    }
    function isPPH(h, m) {
        var pair = -1; var counts={}; for(var i=0;i<h.length;i++) counts[h[i]]=(counts[h[i]]||0)+1;
        for(var k in counts) if(counts[k]==2) { pair=parseInt(k); break; }
        if(pair==-1) return false;
        var cp = h.slice(); removeOne(cp, pair); removeOne(cp, pair);
        for(var i=0; i<cp.length; i+=3) if(cp[i] != cp[i+1] || cp[i] != cp[i+2]) return false;
        return true;
    }

    function showResult(winnerId, title, dummyS, dummyD, isZimo) {
        safeStyle('modal', 'display', 'flex');
        var rt = document.getElementById('res-title'); if(rt) rt.innerText = title;
        
        var p = G.ps[winnerId];
        var winTile = isZimo ? p.hand[p.hand.length-1] : G.last;
        
        var fullH = p.hand.slice();
        if(!isZimo) fullH.push(winTile);
        fullH.sort(function(a,b){return a-b});
        
        var base = CUR_ROOM ? CUR_ROOM.base : 100;
        var res = calcFan(fullH, p.meld, winTile, isZimo, false);
        var fan = res.fan; var desc = res.desc;
        if(p.liang) { fan *= 2; desc += " äº®å€’ x2"; }
        
        var score = base * fan;
        var rd = document.getElementById('res-desc'); if(rd) rd.innerText = desc + "\næ€»å€æ•°: " + fan + "å€";
        
        var userWin = (winnerId === 0);
        var rs = document.getElementById('res-score');
        if(userWin) {
            SCORE += score; 
            if(rs) { rs.innerText = "+" + score; rs.style.color = "#d32f2f"; }
        } else {
            SCORE -= score;
            if(rs) { rs.innerText = "-" + score; rs.style.color = "#388e3c"; }
        }
        updateGlobalScore();
        saveData();
    }

    // --- æ¸²æŸ“ (å¹³æ¿é€‚é…å‡½æ•°) ---
    function render() {
        updateGlobalScore();
        renderP(0, 'melds-0', 'hand-0', 'river-0', 'tag-0', 'ting-box-0', 't-tiles-0');
        renderP(1, 'melds-1', 'hand-1', 'river-1', 'tag-1', 'ting-box-1', 't-tiles-1');
        renderP(2, 'melds-2', 'hand-2', 'river-2', 'tag-2', 'ting-box-2', 't-tiles-2');
    }

    function renderP(id, mId, hId, rId, tagId, tBoxId, tTilesId) {
        var p = G.ps[id];
        var mH=""; for(var i=0;i<p.meld.length;i++) { var n=p.meld[i].t=='gang'?4:3; for(var k=0;k<n;k++) mH+=div(p.meld[i].v, 'tile-meld'); mH+='<div style="width:5px"></div>'; }
        safeHtml(mId, mH);
        var rH=""; for(var i=0;i<p.river.length;i++) rH+=div(p.river[i], 'tile-dropped');
        safeHtml(rId, rH);
        
        safeStyle(tagId, 'display', p.liang?'inline-block':'none');
        
        if(p.liang || (id==0 && p.liang)) {
            var tings = p.ting.length>0 ? p.ting : (id==0?getWinTiles(p.hand, p.meld):[]);
            if(tings.length>0) {
                safeStyle(tBoxId, 'display', 'flex');
                var tH=""; for(var w=0;w<tings.length;w++) tH+=div(tings[w], 'tile-tiny');
                safeHtml(tTilesId, tH);
            } else safeStyle(tBoxId, 'display', 'none');
        } else safeStyle(tBoxId, 'display', 'none');

        var hEl = document.getElementById(hId);
        if(hEl) {
            if(id==0) {
                hEl.className = 'my-hand';
                var hH=""; var len = p.hand.length - (G.turn==0&&G.drawn ? 1 : 0);
                for(var i=0;i<len;i++) hH+=divClick(p.hand[i], i==G.sel, i, false);
                if(G.turn==0&&G.drawn) hH+='<div style="width:15px"></div>'+divClick(p.hand[p.hand.length-1], (p.hand.length-1)==G.sel, p.hand.length-1, false);
                hEl.innerHTML = hH;
            } else {
                hEl.className = 'opp-hand';
                if(p.liang) {
                    hEl.innerHTML = "ğŸ´ å·²äº®å€’ (ç‚¹å‡»æŸ¥çœ‹)";
                    hEl.style.color = "gold";
                    hEl.style.border = "2px solid gold";
                } else {
                    hEl.innerHTML = "å‰©" + p.hand.length + "å¼ ";
                    hEl.style.color = "#ccc";
                    hEl.style.border = "1px solid rgba(255,255,255,0.1)";
                }
            }
        }
    }
    
    // --- é¢œè‰²å¤„ç† ---
    function div(v, cls) { 
        if(v===20) return '<div class="tile '+cls+'"><div class="bai-ban"></div></div>';
        
        // åˆ†é…é¢œè‰²
        var colorClass = "";
        if(v >= 0 && v <= 8) colorClass = "c-tong";      // ç­’å­ 0-8
        else if(v >= 9 && v <= 17) colorClass = "c-tiao";// æ¡å­ 9-17
        else if(v === 18) colorClass = "c-red";          // çº¢ä¸­
        else if(v === 19) colorClass = "c-tiao";         // å‘è´¢
        
        return '<div class="tile '+cls+'"><div class="tile-txt '+colorClass+'">'+TILE_CHARS[v]+'</div></div>'; 
    }
    
    function divClick(v, sel, idx, isSmall) { 
        if(v===20) return '<div class="tile '+(sel?'selected':'')+' '+(isSmall?'tile-small':'')+'" onclick="clk('+idx+')"><div class="bai-ban"></div></div>';
        
        var colorClass = "";
        if(v >= 0 && v <= 8) colorClass = "c-tong";
        else if(v >= 9 && v <= 17) colorClass = "c-tiao";
        else if(v === 18) colorClass = "c-red";
        else if(v === 19) colorClass = "c-tiao";

        return '<div class="tile '+(sel?'selected':'')+' '+(isSmall?'tile-small':'')+'" onclick="clk('+idx+')"><div class="tile-txt '+colorClass+'">'+TILE_CHARS[v]+'</div></div>'; 
    }

    function showBig(v) { 
        safeHtml('big-card', div(v, 'tile-big')); 
    }

    if(window.plus){plusReady();}else{
        // å…³é”®ä¿®å¤ï¼šç¡®ä¿DOMåŠ è½½å®Œæˆåå†æ‰§è¡Œåˆå§‹åŒ–
        window.onload = function() { initApp(); }
    }
    function plusReady(){
        plus.navigator.closeSplashscreen();
        plus.screen.lockOrientation("landscape-primary");
        initApp();
    }
</script>
</body>
</html>
