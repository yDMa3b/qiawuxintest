<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <title>å¥¶å¥¶çš„éº»å°† (Redmi Pad Proç‰ˆ)</title>
    <style>
        /* --- 1. åŸºç¡€è®¾ç½® --- */
        html, body {
            background-color: #0b4d28 !important; width: 100%; height: 100%; margin: 0; padding: 0;
            overflow: hidden; user-select: none; -webkit-user-select: none; 
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", "Microsoft YaHei", sans-serif;
            display: flex; flex-direction: column;
        }

        /* --- 2. å“åº”å¼å˜é‡ç³»ç»Ÿ --- */
        :root {
            /* æ‰‹æœº/é»˜è®¤ç«–å±å°ºå¯¸ */
            --tile-w: 44px; --tile-h: 64px;
            --font-sm: 12px; --font-md: 16px; --font-lg: 20px; --font-xl: 36px;
            --btn-pad: 10px 25px;
            --opp-height: 150px;
        }

        /* --- å¹³æ¿/æ¨ªå±é€‚é… (é’ˆå¯¹ Redmi Pad Pro 12.1") --- */
        @media screen and (orientation: landscape) {
            :root {
                /* ç¨å¾®è°ƒæ•´ç‰Œçš„å¤§å°ï¼Œæ¨ªå±ä¸éœ€è¦ç«–å±é‚£ä¹ˆå·¨å¤§ï¼Œä½†è¦æ¸…æ™° */
                --tile-w: 58px; --tile-h: 82px; 
                --font-sm: 18px; --font-md: 22px; --font-lg: 28px; --font-xl: 50px;
                --btn-pad: 15px 40px;
                --opp-height: 220px; /* å¢åŠ å¯¹æ‰‹åŒºåŸŸé«˜åº¦ */
            }
        }

        /* å¯åŠ¨å±‚ */
        #start-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #start-btn {
            font-size: var(--font-lg); padding: var(--btn-pad); background: #d32f2f; color: white;
            border: 4px solid white; border-radius: 50px; font-weight: bold; cursor: pointer;
        }
        
        #debug-console {
            position: fixed; top: 0; left: 0; width: 100%; background: rgba(0,0,0,0.5); 
            color: #ffcccc; font-size: 12px; z-index: 10000; padding: 5px; pointer-events: none; display: none;
        }

        /* å¤§å… */
        #lobby-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0b4d28 0%, #002200 100%);
            z-index: 9000; display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .lobby-title { font-size: var(--font-xl); color: gold; font-weight: bold; margin-bottom: 30px; text-shadow: 4px 4px 8px #000; font-family: sans-serif; }
        .lobby-info { font-size: var(--font-lg); color: #fff; margin-bottom: 40px; background: rgba(0,0,0,0.4); padding: 10px 30px; border-radius: 30px; font-family: sans-serif; }
        
        .room-container { 
            display: flex; gap: 30px; flex-wrap: nowrap; /* æ¨ªå±ä¸æ¢è¡Œ */
            justify-content: center; width: 90%; 
        }
        .room-btn {
            width: 25%; min-width: 200px; height: 220px; border-radius: 20px;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: white; box-shadow: 0 8px 16px rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3);
            cursor: pointer; transition: transform 0.1s; font-family: sans-serif;
            position: relative;
        }
        .room-btn:active { transform: scale(0.95); }
        .bg-green { background: linear-gradient(to bottom, #66bb6a, #43a047); }
        .bg-blue { background: linear-gradient(to bottom, #42a5f5, #1e88e5); }
        .bg-red { background: linear-gradient(to bottom, #ef5350, #e53935); }
        .room-name { font-size: var(--font-lg); font-weight: bold; margin-bottom: 10px; }
        .room-desc { font-size: var(--font-sm); opacity: 0.9; }
        .room-lock { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.6); border-radius:20px; display:none; 
            justify-content:center; align-items:center; font-size:50px; z-index: 10;
        }

        /* æ¸¸æˆä¸»ç•Œé¢ */
        #game-layer { display: none; width: 100%; height: 100%; flex-direction: column; }
        .header { 
            flex: 0 0 50px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; font-size: var(--font-md); color: gold; background: rgba(0,0,0,0.3); font-family: sans-serif;
            z-index: 50;
        }
        .main-area { flex: 1; display: flex; flex-direction: column; position: relative; width: 100%; }

        /* --- æ ¸å¿ƒå¸ƒå±€ï¼šå¯¹æ‰‹åŒºåŸŸ (æ¨ªå±ä¼˜åŒ–) --- */
        .opponents { 
            flex: 0 0 var(--opp-height); 
            display: flex; 
            justify-content: space-between; /* å·¦å³åˆ†å¼€ */
            padding: 10px 40px; 
            align-items: flex-start;
        }
        .opp-box { 
            width: 35%; /* å˜çª„ï¼Œç»™ä¸­é—´ç•™ç©º */
            display: flex; flex-direction: column; align-items: center; 
        }
        /* é’ˆå¯¹å·¦ä¸Šè§’å¯¹æ‰‹çš„å¾®è°ƒ */
        .opp-box:first-child { align-items: flex-start; }
        /* é’ˆå¯¹å³ä¸Šè§’å¯¹æ‰‹çš„å¾®è°ƒ */
        .opp-box:last-child { align-items: flex-end; }

        .opp-name { font-size: var(--font-md); color: #ddd; margin-bottom: 5px; text-shadow: 1px 1px 2px #000; font-family: sans-serif; display: flex; align-items: center; gap: 5px;}
        .opp-hand { background: rgba(0,0,0,0.3); padding: 5px 15px; border-radius: 10px; font-size: var(--font-md); color: #ccc; font-family: sans-serif; }
        .opp-melds { display: flex; height: calc(var(--tile-h) * 0.7); margin-bottom: 5px; justify-content: center; }
        .opp-hand-open { display: flex; justify-content: center; flex-wrap: wrap; }
        
        .river { 
            width: 100%; height: calc(var(--tile-h) * 1.6); 
            background: rgba(0,0,0,0.15); border-radius: 8px; 
            display: flex; flex-wrap: wrap; align-content: flex-start; padding: 4px; margin-top: 5px; 
        }
        /* æ¨ªå±ä¸‹ï¼Œç‰Œæ²³(å¼ƒç‰Œå †)ç¨å¾®å®½ä¸€ç‚¹ */
        @media screen and (orientation: landscape) {
            .river { width: 120%; height: calc(var(--tile-h) * 1.8); }
            /* å·¦è¾¹å¯¹æ‰‹ç‰Œæ²³å‘å³å»¶ä¼¸ */
            .opp-box:first-child .river { align-self: flex-start; }
            /* å³è¾¹å¯¹æ‰‹ç‰Œæ²³å‘å·¦å»¶ä¼¸ */
            .opp-box:last-child .river { align-self: flex-end; flex-direction: row-reverse; } 
            .opp-box:last-child .river .tile-dropped { margin: -6px -4px; } /* ä¿®æ­£åå‘æ’åˆ—é—´è· */
        }

        /* å¬ç‰Œæç¤º */
        .ting-box { display: none; background: rgba(0,0,0,0.7); padding: 4px 10px; border-radius: 10px; border: 2px solid #ff9800; align-items: center; margin-bottom: 5px; }
        .ting-txt { color: #ff9800; font-size: var(--font-md); margin-right: 5px; font-family: sans-serif; }
        .liang-tag { background: #ff9800; color: black; font-weight: bold; font-size: var(--font-sm); padding: 2px 6px; border-radius: 4px; margin-left: 5px; display: none; border: 1px solid white; font-family: sans-serif;}

        /* ä¸­é—´ä¿¡æ¯åŒº (å‡ºç‰Œå±•ç¤º/æ¶ˆæ¯) */
        .center-stage { 
            flex: 1; display: flex; flex-direction: column; 
            justify-content: center; align-items: center; 
            position: relative; top: -40px; /* ç¨å¾®ä¸Šç§» */
            pointer-events: none; /* é˜²æ­¢é®æŒ¡ç‚¹å‡» */
        }
        #msg { 
            font-size: var(--font-lg); color: white; background: rgba(0,0,0,0.6); 
            padding: 10px 30px; border-radius: 30px; margin-bottom: 20px; font-weight: bold; 
            font-family: sans-serif; text-align: center; pointer-events: auto;
        }
        #big-card { 
            width: calc(var(--tile-w) * 1.5); height: calc(var(--tile-h) * 1.5); 
            display: flex; justify-content: center; align-items: center; 
        }

        /* ç©å®¶åŒºåŸŸ */
        .my-area { 
            flex: 0 0 auto; display: flex; flex-direction: column; justify-content: flex-end; 
            padding-bottom: 10px; width: 100%; 
        }
        .my-river-box { display: flex; justify-content: center; margin-bottom: 5px; }
        .my-river { 
            width: 50%; /* ç©å®¶ç‰Œæ²³ä¸è¦å¤ªå®½ */
            height: calc(var(--tile-h) * 1.4); 
            background: rgba(0,0,0,0.2); border-radius: 8px; display: flex; flex-wrap: wrap; justify-content: center; padding: 4px; 
        }
        
        .my-info-row { display: flex; justify-content: center; align-items: center; height: 40px; margin-bottom: 5px; }
        
        /* æŒ‰é’®ç»„ - æ¨ªå±ä¼˜åŒ– */
        .btn-row { 
            display: flex; justify-content: center; gap: 40px; height: 80px; align-items: center; 
            margin-bottom: 10px; z-index: 200; 
        }
        .btn { 
            padding: var(--btn-pad); border-radius: 50px; border: none; 
            font-size: var(--font-lg); font-weight: bold; box-shadow: 0 5px 10px rgba(0,0,0,0.5); 
            transition: transform 0.1s; font-family: sans-serif; white-space: nowrap; cursor: pointer;
        }
        .btn:active { transform: scale(0.9); }
        .btn-hu { background: #d32f2f; color: white; animation: pulse 1s infinite; }
        .btn-peng { background: #1976d2; color: white; }
        .btn-gang { background: #7b1fa2; color: white; }
        .btn-pass { background: #666; color: white; }
        .btn-liang { background: linear-gradient(to bottom, #ffeb3b, #fbc02d); color: black; border: 3px solid white; display: none; }
        .btn-out { background: gold; color: black; display: none; padding: 15px 80px; border: 3px solid #fff; box-shadow: 0 0 15px gold;}

        .hand-row { display: flex; justify-content: center; align-items: flex-end; padding: 0 20px 20px 20px; }
        .my-melds { display: flex; margin-right: 30px; }
        .my-hand { display: flex; }

        /* éº»å°†ç‰Œæ ·å¼ */
        .tile { 
            width: var(--tile-w); height: var(--tile-h); 
            background: #fdfdfd; border-radius: 6px; margin: 2px; 
            position: relative; display: flex; justify-content: center; align-items: center; 
            box-shadow: 2px 4px 5px rgba(0,0,0,0.4); border: 1px solid #bbb;
            flex-shrink: 0;
            font-family: "Apple Color Emoji", "Segoe UI Emoji", "Noto Color Emoji", sans-serif;
        }
        /* å­—ä½“å¤§å°éš tile å¤§å°å˜åŒ– */
        .tile-txt { font-size: calc(var(--tile-w) * 0.9); line-height: 1; margin-top: -4px; }
        
        .tile.selected { transform: translateY(-30px); border: 3px solid gold; background: #fffbe6; z-index: 10; }
        .tile-dropped { transform: scale(0.85); margin: -6px -4px; border: 1px solid #ccc; box-shadow: none; }
        .tile-meld { transform: scale(0.8); margin: -8px -6px; background: #eef; }
        .tile-big { transform: scale(2.0); box-shadow: 0 0 30px yellow; z-index: 100; background: #fff; }
        .tile-small { transform: scale(0.7); margin: -10px -5px; }
        .tile-tiny { transform: scale(0.6); margin: -15px -8px; background: #fffbe6; border: 1px solid orange; }

        .bai-ban { width: 70%; height: 75%; border: 4px solid #1046b1; border-radius: 4px; box-sizing: border-box; }

        @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.1);} 100%{transform:scale(1);} }

        /* ç»“ç®—å¼¹çª— */
        .modal { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 5000; }
        .res-box { background: white; color: #333; width: 50%; max-width: 600px; padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(255,215,0,0.5); border: 5px solid gold;}
        .res-title { font-size: 50px; font-weight: bold; margin-bottom: 20px; font-family: sans-serif; }
        .res-detail { font-size: 24px; color: #555; margin-bottom: 30px; line-height: 1.8; text-align: left; padding-left: 40px; font-family: sans-serif;}
        .res-score { font-size: 80px; font-weight: bold; color: #d32f2f; margin: 20px 0; font-family: sans-serif; }
        .res-btn { padding: 15px 60px; background: #388e3c; color: white; border: none; border-radius: 50px; font-size: 30px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3); font-family: sans-serif;}
        
        .toast { position: fixed; top: 40%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: gold; padding: 20px 40px; border-radius: 15px; font-size: 24px; z-index: 9999; display: none; text-align: center; border: 3px solid gold; font-family: sans-serif;}
    </style>
</head>
<body>
    <div id="debug-console"></div>
    <div id="start-layer">
        <button id="start-btn" onclick="initApp()">è¿›å…¥æ¸¸æˆ (æ¨ªå±ç‰ˆ)</button>
    </div>

    <div id="lobby-layer" style="display:none;">
        <div class="lobby-title">ğŸ€„ï¸ å•æœºå¡äº”æ˜Ÿ (HD) ğŸ€„ï¸</div>
        <div class="lobby-info">æ‚¨çš„é‡‘è±†: <span id="user-score-disp-1">è¯»å–ä¸­...</span></div>
        <div class="room-container">
            <div class="room-btn bg-green" onclick="enterRoom(0)"><div class="room-name">ğŸŸ¢ åˆçº§åœº</div><div class="room-desc">åº•åˆ†100</div></div>
            <div class="room-btn bg-blue" onclick="enterRoom(1)">
                <div class="room-name">ğŸ”µ ä¸­çº§åœº</div><div class="room-desc">åº•åˆ†500</div>
                <div class="room-lock" id="lock-1">ğŸ”’</div>
            </div>
            <div class="room-btn bg-red" onclick="enterRoom(2)">
                <div class="room-name">ğŸ”´ é«˜çº§åœº</div><div class="room-desc">åº•åˆ†2000</div>
                <div class="room-lock" id="lock-2">ğŸ”’</div>
            </div>
        </div>
    </div>

    <div id="game-layer">
        <div class="header">
            <div id="room-info-disp" style="color:white; font-weight:bold;">åˆçº§åœº</div>
            <div>ğŸ’° <span id="user-score-disp-2"></span></div>
        </div>

        <div class="main-area">
            <div class="opponents">
                <div class="opp-box">
                    <div class="opp-name">â¬…ï¸ ä¸Šå®¶ <span class="liang-tag" id="tag-2">äº®</span></div>
                    <div class="ting-box" id="ting-box-2"><span class="ting-txt">èƒ¡:</span><div id="t-tiles-2" style="display:flex"></div></div>
                    <div class="opp-melds" id="melds-2"></div>
                    <div class="opp-hand" id="hand-2">å‰©13å¼ </div>
                    <div class="river" id="river-2"></div>
                </div>
                <div class="opp-box">
                    <div class="opp-name"><span class="liang-tag" id="tag-1">äº®</span> ä¸‹å®¶ â¡ï¸</div>
                    <div class="ting-box" id="ting-box-1"><span class="ting-txt">èƒ¡:</span><div id="t-tiles-1" style="display:flex"></div></div>
                    <div class="opp-melds" id="melds-1"></div>
                    <div class="opp-hand" id="hand-1">å‰©13å¼ </div>
                    <div class="river" id="river-1"></div>
                </div>
            </div>

            <div class="center-stage">
                <div id="msg">å‡†å¤‡å¼€å§‹</div>
                <div id="big-card"></div>
            </div>

            <div class="my-area">
                <div class="my-river-box"><div class="my-river" id="river-0"></div></div>
                
                <div class="my-info-row">
                    <span class="liang-tag" id="tag-0">å·²äº®å€’</span>
                    <div class="ting-box" id="ting-box-0" style="margin-left:10px;">
                        <span class="ting-txt">ä½ èƒ¡:</span><div id="t-tiles-0" style="display:flex"></div>
                    </div>
                </div>
                <div class="btn-row" id="btn-box"></div>
                <div class="hand-row">
                    <div class="my-melds" id="melds-0"></div>
                    <div class="my-hand" id="hand-0"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="res-box">
            <div id="res-title" class="res-title">èƒ¡ç‰Œå•¦</div>
            <div id="res-desc" class="res-detail"></div>
            <div id="res-score" class="res-score">+3200</div>
            <button class="res-btn" onclick="backToLobby()">è¿”å›å¤§å…</button>
        </div>
    </div>
    
    <div class="toast" id="toast">ç ´äº§äº†ï¼<br>ç³»ç»Ÿèµ é€ 3000 æ•‘æµé‡‘</div>

<script>
    var debug = document.getElementById('debug-console');
    window.onerror = function(msg, url, line) {
        debug.style.display = 'block'; debug.innerHTML += "Err: " + msg + " (L" + line + ")<br>"; return false;
    };

    var COLORS = { b: "#0033cc", g: "#008800", r: "#cc0000", black: "#000" }; 
    var TILE_CHARS = [
        'ğŸ€™','ğŸ€š','ğŸ€›','ğŸ€œ','ğŸ€','ğŸ€','ğŸ€Ÿ','ğŸ€ ','ğŸ€¡', 
        'ğŸ€','ğŸ€‘','ğŸ€’','ğŸ€“','ğŸ€”','ğŸ€•','ğŸ€–','ğŸ€—','ğŸ€˜', 
        'ğŸ€„','ğŸ€…','' 
    ];

    var ROOMS = [
        {name:"åˆçº§åœº", min:0, base:100, ai:0},
        {name:"ä¸­çº§åœº", min:10000, base:500, ai:1},
        {name:"é«˜çº§åœº", min:50000, base:2000, ai:2}
    ];
    var SCORE = 10000;
    
    function loadData() {
        var s = localStorage.getItem('nainai_mahjong_score');
        if(s) { SCORE = parseInt(s); if(isNaN(SCORE)) SCORE = 10000; } else SCORE = 10000;
    }
    function saveData() { localStorage.setItem('nainai_mahjong_score', SCORE); }

    var CUR_ROOM = null;
    var G = { deck:[], ps:[], turn:0, last:-1, from:-1, sel:-1, drawn:false, gangInfo:null, pendingLiang:false };

    function initApp() { loadData(); document.getElementById('start-layer').style.display = 'none'; initLobby(); }

    function initLobby() {
        document.getElementById('lobby-layer').style.display = 'flex';
        document.getElementById('game-layer').style.display = 'none';
        document.getElementById('modal').style.display = 'none';
        if(SCORE <= 0) { SCORE = 3000; saveData(); var t=document.getElementById('toast'); t.style.display='block'; setTimeout(function(){t.style.display='none'}, 2500); }
        updateGlobalScore();
        document.getElementById('lock-1').style.display = SCORE < 10000 ? 'flex' : 'none';
        document.getElementById('lock-2').style.display = SCORE < 50000 ? 'flex' : 'none';
    }

    function updateGlobalScore() {
        var el1 = document.getElementById('user-score-disp-1'); if(el1) el1.innerText = SCORE;
        var el2 = document.getElementById('user-score-disp-2'); if(el2) el2.innerText = SCORE;
    }

    function enterRoom(id) {
        var r = ROOMS[id];
        if(SCORE < r.min) { alert("é‡‘è±†ä¸è¶³ï¼"); return; }
        CUR_ROOM = r;
        document.getElementById('lobby-layer').style.display = 'none';
        document.getElementById('game-layer').style.display = 'flex';
        document.getElementById('room-info-disp').innerText = r.name + " (åº•åˆ†"+r.base+")";
        updateGlobalScore();
        startGame();
    }
    function backToLobby() { initLobby(); }

    function startGame() {
        hideActs();
        G.deck=[]; for(var i=0;i<=20;i++) for(var k=0;k<4;k++) G.deck.push(i);
        for(var i=G.deck.length-1;i>0;i--) { var j=Math.floor(Math.random()*(i+1)); var t=G.deck[i]; G.deck[i]=G.deck[j]; G.deck[j]=t; }
        G.ps = [];
        for(var i=0;i<3;i++) {
            var s = (i==0 ? SCORE : 100000);
            var h=[]; for(var k=0;k<13;k++) h.push(G.deck.pop());
            h.sort(function(a,b){return a-b});
            G.ps.push({ hand:h, meld:[], river:[], liang:false, ting:[], score:s });
        }
        G.turn = 0; G.drawn = false; G.sel = -1; G.pendingLiang = false;
        render(); setMsg("åº„å®¶æ‘¸ç‰Œ...");
        setTimeout(drawCard, 800);
    }

    function drawCard() {
        if(G.deck.length==0) { alert("æµå±€"); backToLobby(); return; }
        var p = G.ps[G.turn]; var c = G.deck.pop(); p.hand.push(c);
        if(G.turn == 0) { 
            G.drawn = true; G.sel = -1; render();
            if(p.liang) {
                setMsg("å·²äº®å€’ï¼šè‡ªåŠ¨æ‰“ç‰Œ");
                if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("äº®å€’è‡ªæ‘¸ï¼"); }
                else { setTimeout(function(){ actDiscardForce(p.hand.length-1); }, 1000); }
                return;
            }
            if(checkWin(p.hand, p.meld)) { showActs(['HU','PASS']); setMsg("æ‘¸åˆ°å¥½ç‰Œï¼"); }
            else {
                setMsg("è¯·å‡ºç‰Œ");
                var canLiang = checkCanLiang(p.hand, p.meld);
                var gangInfo = checkGang(p);
                var acts = [];
                if(canLiang) acts.push('LIANG');
                if(gangInfo) { G.gangInfo=gangInfo; acts.push('GANG'); }
                if(acts.length>0) showActs(acts, true); else showActs([], true);
            }
        } else { 
            render(); setMsg((G.turn==1?"ä¸‹å®¶":"ä¸Šå®¶")+"æ€è€ƒä¸­...");
            setTimeout(function(){ aiPlay(p); }, 800);
        }
    }

    function aiPlay(p) {
        if(checkWin(p.hand, p.meld)) { showResult(G.turn, "ç”µè„‘èƒ¡äº†", 0, "è‡ªæ‘¸", true); return; }
        
        if(!p.liang && CUR_ROOM.ai > 0) {
            for(var i=0; i<p.hand.length; i++) {
                var tmp = p.hand.slice(); var dc = tmp.splice(i,1)[0];
                var tings = getWinTiles(tmp, p.meld);
                if(tings.length>0 && Math.random() < (CUR_ROOM.ai==2?0.9:0.6)) {
                    p.liang=true; p.ting=tings; p.hand=tmp;
                    G.last = dc; G.from = G.turn; G.drawn = false;
                    showBig(dc); render(); checkResp(); return;
                }
            }
        }
        if(p.liang) { var c = p.hand.pop(); playCard(c); return; }
        
        var danger = (G.ps[0].liang && CUR_ROOM.ai==2) ? G.ps[0].ting : [];
        var counts={}; for(var i=0;i<p.hand.length;i++) counts[p.hand[i]]=(counts[p.hand[i]]||0)+1;
        var best = -1;
        for(var i=0; i<p.hand.length; i++) {
            var t = p.hand[i];
            if(danger.indexOf(t)==-1) {
                if(counts[t]==1) { if(t>=18) { best=i; break; } if(best==-1) best=i; }
            }
        }
        if(best==-1) best = Math.floor(Math.random()*p.hand.length);
        var c = p.hand.splice(best, 1)[0]; p.hand.sort(function(a,b){return a-b});
        playCard(c);
    }

    function playCard(c) { G.last = c; G.from = G.turn; G.drawn = false; showBig(c); render(); checkResp(); }

    function checkResp() {
        var c = G.last;
        if(G.from != 0) {
            var p = G.ps[0]; var acts = [];
            var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
            if(checkWin(tmp, p.meld)) acts.push('HU');
            if(!p.liang) {
                var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
                if(cnt>=2) acts.push('PENG'); if(cnt==3) acts.push('GANG');
            }
            if(acts.length>0) { acts.push('PASS'); showActs(acts); setMsg("æœ‰æ“ä½œ"); return; }
        }
        var n1 = (G.from+1)%3; if(aiResp(n1, c)) return;
        var n2 = (G.from+2)%3; if(aiResp(n2, c)) return;
        G.ps[G.from].river.push(c); nextTurn();
    }

    function aiResp(id, c) {
        if(id==0 || id==G.from) return false;
        var p = G.ps[id];
        var tmp = p.hand.slice(); tmp.push(c); tmp.sort(function(a,b){return a-b});
        
        if(checkWin(tmp, p.meld)) { showResult(id, "ç”µè„‘èƒ¡äº†", 0, "æ‰ç‚®", false); return true; }
        
        if(p.liang) return false;
        var cnt=0; for(var i=0;i<p.hand.length;i++) if(p.hand[i]==c) cnt++;
        var rate = CUR_ROOM.ai==2 ? 0.9 : 0.5;
        if(cnt==3) { aiAct(id, 'gang', c); return true; }
        if(cnt>=2 && Math.random()<rate) { aiAct(id, 'peng', c); return true; }
        return false;
    }

    function aiAct(id, type, c) {
        var p = G.ps[id];
        rem(p.hand, c, (type=='gang'?3:2)); p.meld.push({v:c, t:type});
        G.turn = id; document.getElementById('big-card').innerHTML='';
        setMsg("ç”µè„‘"+(type=='gang'?"æ ":"ç¢°")); render();
        if(type=='gang') setTimeout(drawCard, 800);
        else setTimeout(function(){
            var dc = p.hand.splice(0,1)[0]; p.hand.sort(function(a,b){return a-b}); playCard(dc);
        }, 800);
    }

    function nextTurn() { document.getElementById('big-card').innerHTML=''; G.turn = (G.turn+1)%3; render(); setTimeout(drawCard, 500); }

    function actDiscard() {
        if(G.sel == -1) return;
        var p = G.ps[0];
        if(p.liang && G.sel != p.hand.length-1) { setMsg("äº®å€’è§„åˆ™ï¼šåªèƒ½æ‰“æ–°æ‘¸çš„ç‰Œ"); return; }
        actDiscardForce(G.sel);
    }
    
    function actDiscardForce(idx) {
        var p = G.ps[0];
        var c = p.hand.splice(idx, 1)[0]; p.hand.sort(function(a,b){return a-b});
        if(G.pendingLiang) { p.liang=true; G.pendingLiang=false; p.ting=getWinTiles(p.hand, p.meld); }
        hideActs(); playCard(c);
    }

    function actLiang() { G.pendingLiang = true; setMsg("è¯·æ‰“å‡ºä¸€å¼ ç‰Œä»¥äº®å€’"); hideActs(); document.getElementById('btn-out').style.display='block'; }
    function actGangSelf() {
        var p = G.ps[0]; var g = G.gangInfo;
        if(g.type=='an') { rem(p.hand, g.v, 4); p.meld.push({v:g.v, t:'gang'}); }
        else { rem(p.hand, g.v, 1); for(var i=0;i<p.meld.length;i++) if(p.meld[i].v==g.v) p.meld[i].t='gang'; }
        G.gangInfo=null; hideActs(); render(); setTimeout(drawCard, 500);
    }
    function doAct(a) {
        hideActs(); document.getElementById('big-card').innerHTML='';
        var p = G.ps[0]; var c = G.last;
        if(a=='PASS') {
            if(p.liang && G.turn==0) { var dc = p.hand.pop(); p.hand.sort(function(a,b){return a-b}); playCard(dc); } 
            else { G.ps[G.from].river.push(c); nextTurn(); }
        }
        else if(a=='HU') { showResult(0, "èƒ¡ç‰Œå•¦", 0, "", G.from==0); } // ç©å®¶èµ¢ID=0
        else if(a=='LIANG') actLiang();
        else if(a=='GANG') { 
            if(G.turn==0) actGangSelf(); else { rem(p.hand,c,3); p.meld.push({v:c,t:'gang'}); G.turn=0; setMsg("æ ï¼Œæ‘¸ä¸€å¼ "); setTimeout(drawCard,500); }
        }
        else if(a=='PENG') { rem(p.hand,c,2); p.meld.push({v:c,t:'peng'}); G.turn=0; G.drawn=true; G.sel=-1; setMsg("ç¢°ï¼Œè¯·å‡ºç‰Œ"); render(); showActs([], true); }
    }

    function clk(idx) {
        if(G.turn!=0 || !G.drawn) return;
        var p = G.ps[0];
        if(p.liang && idx!=p.hand.length-1) { setMsg("äº®å€’ååªèƒ½æ“ä½œæ–°æ‘¸çš„ç‰Œ"); return; }
        var realIdx = (p.liang || (G.turn==0&&G.drawn)) && idx == p.hand.length-1 ? idx : idx;
        if(G.sel == realIdx) actDiscard();
        else { G.sel = realIdx; render(); showActs([], true); }
    }

    // --- ç®—æ³• ---
    function checkWin(h, m) {
        if(m.length==0 && h.length==14 && is7(h)) return true;
        var c={}; for(var i=0;i<h.length;i++) c[h[i]]=(c[h[i]]||0)+1;
        var pair=[]; for(var k in c) if(c[k]>=2) pair.push(parseInt(k));
        for(var i=0;i<pair.length;i++) { var cp = h.slice(); removeOne(cp,pair[i]); removeOne(cp,pair[i]); if(isHu(cp)) return true; }
        return false;
    }
    function is7(h){ for(var i=0;i<14;i+=2) if(h[i]!=h[i+1]) return false; return true; }
    function isHu(t) {
        if(t.length==0) return true;
        var f=t[0]; var cnt=0; for(var i=0;i<t.length;i++) if(t[i]==f) cnt++;
        if(cnt>=3) { var cp=t.slice(); removeOne(cp,f); removeOne(cp,f); removeOne(cp,f); if(isHu(cp)) return true; }
        if(f<18) {
            if(t.indexOf(f+1)>-1 && t.indexOf(f+2)>-1) {
                if(Math.floor(f/9) == Math.floor((f+2)/9)) { var cp=t.slice(); removeOne(cp,f); removeOne(cp,f+1); removeOne(cp,f+2); if(isHu(cp)) return true; }
            }
        } return false;
    }
    function removeOne(arr, v) { var idx = arr.indexOf(v); if(idx>-1) { arr.splice(idx, 1); return true; } return false; }
    function rem(a,v,n) { for(var i=0;i<n;i++) removeOne(a,v); }
    function checkGang(p) {
        var c={}; for(var i=0;i<p.hand.length;i++) c[p.hand[i]]=(c[p.hand[i]]||0)+1;
        for(var k in c) if(c[k]==4) return {type:'an', v:parseInt(k)};
        for(var i=0;i<p.hand.length;i++) for(var m=0;m<p.meld.length;m++) if(p.meld[m].t=='peng' && p.meld[m].v==p.hand[i]) return {type:'bu', v:p.hand[i]};
        return null;
    }
    function checkCanLiang(h,m) {
        for(var i=0;i<h.length;i++) {
            var tmp=h.slice(); tmp.splice(i,1);
            if(getWinTiles(tmp,m).length>0) return true;
        } return false;
    }
    function getWinTiles(h13, m) { var w=[]; for(var t=0;t<=20;t++) { var tmp=h13.slice(); tmp.push(t); tmp.sort(function(a,b){return a-b}); if(checkWin(tmp, m)) w.push(t); } return w; }
    function calcFan(h, m, winTile, isZimo, isGangKai) {
        var fan = 1; var details = ["å¹³èƒ¡"];
        if((winTile==4 || winTile==13)) { if(h.indexOf(winTile-1)>-1 && h.indexOf(winTile+1)>-1) { fan *= 2; details.push("å¡äº”æ˜Ÿ x2"); } }
        if(m.length==0 && h.length==14 && is7(h)) { fan *= 4; details.push("ä¸ƒå¯¹ x4"); }
        else if(isPPH(h, m)) { fan *= 2; details.push("ç¢°ç¢°èƒ¡ x2"); }
        if(isGangKai) { fan *= 2; details.push("æ ä¸Šå¼€èŠ± x2"); }
        if(isZimo) { details.push("è‡ªæ‘¸"); } else { details.push("æ‰ç‚®"); }
        return {fan:fan, desc:details.join(" ")};
    }
    function isPPH(h, m) {
        var pair = -1; var counts={}; for(var i=0;i<h.length;i++) counts[h[i]]=(counts[h[i]]||0)+1;
        for(var k in counts) if(counts[k]==2) { pair=parseInt(k); break; }
        if(pair==-1) return false;
        var cp = h.slice(); removeOne(cp, pair); removeOne(cp, pair);
        for(var i=0; i<cp.length; i+=3) if(cp[i] != cp[i+1] || cp[i] != cp[i+2]) return false;
        return true;
    }

    function showResult(winnerId, title, dummyS, dummyD, isZimo) {
        var m = document.getElementById('modal'); m.style.display='flex';
        document.getElementById('res-title').innerText = title;
        
        var p = G.ps[winnerId];
        var winTile = isZimo ? p.hand[p.hand.length-1] : G.last;
        
        var fullH = p.hand.slice();
        if(!isZimo) fullH.push(winTile);
        fullH.sort(function(a,b){return a-b});
        
        var base = CUR_ROOM ? CUR_ROOM.base : 100;
        var res = calcFan(fullH, p.meld, winTile, isZimo, false);
        var fan = res.fan; var desc = res.desc;
        if(p.liang) { fan *= 2; desc += " äº®å€’ x2"; }
        
        var score = base * fan;
        document.getElementById('res-desc').innerText = desc + "\næ€»å€æ•°: " + fan + "å€";
        
        var userWin = (winnerId === 0);
        if(userWin) {
            SCORE += score; 
            document.getElementById('res-score').innerText = "+" + score;
            document.getElementById('res-score').style.color = "#d32f2f";
        } else {
            SCORE -= score;
            document.getElementById('res-score').innerText = "-" + score;
            document.getElementById('res-score').style.color = "#388e3c";
        }
        updateGlobalScore();
        saveData();
    }

    // --- æ¸²æŸ“ (å¹³æ¿é€‚é…å‡½æ•°) ---
    function render() {
        updateGlobalScore();
        renderP(0, 'melds-0', 'hand-0', 'river-0', 'tag-0', 'ting-box-0', 't-tiles-0');
        renderP(1, 'melds-1', 'hand-1', 'river-1', 'tag-1', 'ting-box-1', 't-tiles-1');
        renderP(2, 'melds-2', 'hand-2', 'river-2', 'tag-2', 'ting-box-2', 't-tiles-2');
    }

    function renderP(id, mId, hId, rId, tagId, tBoxId, tTilesId) {
        var p = G.ps[id];
        var mH=""; for(var i=0;i<p.meld.length;i++) { var n=p.meld[i].t=='gang'?4:3; for(var k=0;k<n;k++) mH+=div(p.meld[i].v, 'tile-meld'); mH+='<div style="width:5px"></div>'; }
        document.getElementById(mId).innerHTML = mH;
        var rH=""; for(var i=0;i<p.river.length;i++) rH+=div(p.river[i], 'tile-dropped');
        document.getElementById(rId).innerHTML = rH;
        if(tagId) document.getElementById(tagId).style.display = p.liang?'inline-block':'none';
        
        var tEl = document.getElementById(tBoxId);
        if(p.liang || (id==0 && p.liang)) {
            var tings = p.ting.length>0 ? p.ting : (id==0?getWinTiles(p.hand, p.meld):[]);
            if(tings.length>0) {
                tEl.style.display='flex'; var tH=""; for(var w=0;w<tings.length;w++) tH+=div(tings[w], 'tile-tiny');
                document.getElementById(tTilesId).innerHTML = tH;
            } else tEl.style.display='none';
        } else tEl.style.display='none';

        var hEl = document.getElementById(hId);
        if(id==0 || p.liang) {
            hEl.className = id==0?'my-hand':'opp-hand-open';
            var hH=""; var len = p.hand.length - (id==0&&G.turn==0&&G.drawn ? 1 : 0);
            for(var i=0;i<len;i++) hH+=divClick(p.hand[i], i==G.sel, i, id!=0);
            if(id==0&&G.turn==0&&G.drawn) hH+='<div style="width:15px"></div>'+divClick(p.hand[p.hand.length-1], (p.hand.length-1)==G.sel, p.hand.length-1, false);
            hEl.innerHTML = hH;
        } else { hEl.className = 'opp-hand'; hEl.innerHTML = "å‰©"+p.hand.length+"å¼ "; }
    }
    
    function div(v, cls) { 
        if(v===20) return '<div class="tile '+cls+'"><div class="bai-ban"></div></div>';
        return '<div class="tile '+cls+'"><div class="tile-txt">'+TILE_CHARS[v]+'</div></div>'; 
    }
    function divClick(v, sel, idx, isSmall) { 
        var content = (v===20)?'<div class="bai-ban"></div>':'<div class="tile-txt">'+TILE_CHARS[v]+'</div>';
        return '<div class="tile '+(sel?'selected':'')+' '+(isSmall?'tile-small':'')+'" onclick="clk('+idx+')">'+content+'</div>'; 
    }
    function showActs(list, showBase) {
        var box = document.getElementById('btn-box'); box.innerHTML='';
        if(showBase) box.innerHTML='<button class="btn btn-out" id="btn-out" onclick="actDiscard()">å‡ºç‰Œ</button>';
        for(var i=0;i<list.length;i++) {
            (function(a){
                var b=document.createElement('button');
                b.className='btn btn-'+a.toLowerCase();
                b.innerText = (a=='HU'?"èƒ¡":(a=='PENG'?"ç¢°":(a=='GANG'?"æ ":(a=='PASS'?"è¿‡":(a=='LIANG'?"äº®å€’":"")))));
                if(a=='PASS' && G.ps[0].liang) { b.innerText="æ‰“å‡º"; b.className+=' btn-pass'; }
                b.onclick=function(){doAct(a)}; box.appendChild(b);
            })(list[i]);
        }
        if(showBase) document.getElementById('btn-out').style.display = 'block';
    }
    function hideActs() { document.getElementById('btn-box').innerHTML=''; }
    function setMsg(t) { document.getElementById('msg').innerText=t; }
    function showBig(v) { document.getElementById('big-card').innerHTML = div(v, 'tile-big'); }

    // --- 3. å…³é”®ä¿®æ”¹ï¼šå¼ºåˆ¶æ¨ªå± (Landscape) ---
    if(window.plus){plusReady();}else{document.addEventListener('plusready',plusReady,false);}
    function plusReady(){
        plus.navigator.closeSplashscreen();
        // ä¿®æ”¹ä¸ºå¼ºåˆ¶æ¨ªå±
        plus.screen.lockOrientation("landscape-primary");
    }
    
    initApp();
</script>
</body>
</html>
